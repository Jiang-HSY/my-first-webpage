<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>äº‘ä¾¿ç­¾ - æé€ŸSVGç‰ˆ</title>
    <!-- ä½¿ç”¨ unpkg æºï¼Œç¡®ä¿å›½å†…åŠ è½½é€Ÿåº¦ -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='40' height='46' viewBox='0 0 40 46' fill='none'><rect width='40' height='46' fill='%232B92FF'/></svg>"
    />
    <style>
      :root {
        --pager-green: #a3d95b;
        --accent-red: #ff6b6b;
        --ui-bg: #2a2a2a;
        --grid-size: 20px;
        --note-width: 320px;
        /* è¿™é‡Œçš„ SVG æ˜¯ä½ æä¾›çš„ï¼Œç»è¿‡ URL ç¼–ç ä»¥ä¾¿åœ¨ CSS ä¸­ä½¿ç”¨ */
        --sawtooth-url: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='320' height='6' viewBox='0 0 320 6' fill='none'%3E%3Cpath d='M320 0V3.34662L317.414 5.51015C316.633 6.16336 315.367 6.1632 314.586 5.51015L310 1.67331L305.414 5.51015C304.633 6.16336 303.367 6.1632 302.586 5.51015L298 1.67331L293.414 5.51015C292.633 6.16336 291.367 6.1632 290.586 5.51015L286 1.67331L281.414 5.51015C280.633 6.16336 279.367 6.1632 278.586 5.51015L274 1.67331L269.414 5.51015C268.633 6.16336 267.367 6.1632 266.586 5.51015L262 1.67331L257.414 5.51015C256.633 6.16336 255.367 6.1632 254.586 5.51015L250 1.67331L245.414 5.51015C244.633 6.16337 243.367 6.1632 242.586 5.51015L238 1.67331L233.414 5.51015C232.633 6.16337 231.367 6.1632 230.586 5.51015L226 1.67331L221.414 5.51015C220.633 6.16337 219.367 6.1632 218.586 5.51015L214 1.67331L209.414 5.51015C208.633 6.16337 207.367 6.1632 206.586 5.51015L202 1.67331L197.414 5.51015C196.633 6.16337 195.367 6.1632 194.586 5.51015L190 1.67331L185.414 5.51015C184.633 6.16337 183.367 6.1632 182.586 5.51015L178 1.67331L173.414 5.51015C172.633 6.16337 171.367 6.1632 170.586 5.51015L166 1.67331L161.414 5.51015C160.633 6.16337 159.367 6.1632 158.586 5.51015L154 1.67331L149.414 5.51015C148.633 6.16337 147.367 6.1632 146.586 5.51015L142 1.67331L137.414 5.51015C136.633 6.16337 135.367 6.1632 134.586 5.51015L130 1.67331L125.414 5.51015C124.633 6.16337 123.367 6.1632 122.586 5.51015L118 1.67331L113.414 5.51015C112.633 6.16337 111.367 6.1632 110.586 5.51015L106 1.67331L101.414 5.51015C100.633 6.16337 99.367 6.1632 98.5859 5.51015L94 1.67331L89.4141 5.51015C88.6332 6.16337 87.367 6.1632 86.5859 5.51015L82 1.67331L77.4141 5.51015C76.6332 6.16337 75.367 6.1632 74.5859 5.51015L70 1.67331L65.4141 5.51015C64.6332 6.16337 63.367 6.1632 62.5859 5.51015L58 1.67331L53.4141 5.51015C52.6332 6.16337 51.367 6.1632 50.5859 5.51015L46 1.67331L41.4141 5.51015C40.6332 6.16337 39.367 6.1632 38.5859 5.51015L34 1.67331L29.4141 5.51015C28.6332 6.16337 27.367 6.1632 26.5859 5.51015L22 1.67331L17.4141 5.51015C16.6332 6.16337 15.367 6.1632 14.5859 5.51015L10 1.67331L5.41406 5.51015C4.63315 6.16337 3.36697 6.1632 2.58594 5.51015L0 3.34662V0H320Z' fill='white'/%3E%3C/svg%3E");
      }
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        background-color: #f0f2f5;
        background-image: radial-gradient(#d1d5db 1.5px, transparent 1.5px);
        background-size: var(--grid-size) var(--grid-size);
        overflow: hidden;
        font-family: "Space Mono", monospace;
        user-select: none;
        touch-action: none;
      }
      #viewport {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform-origin: 0 0;
        cursor: grab;
        will-change: transform;
      }
      .fixed-ui {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
      }
      .pager-container {
        pointer-events: auto;
        margin-bottom: 20px;
        width: 90%;
        max-width: 420px;
        z-index: 2500;
      }
      .pager-body {
        background-color: var(--pager-green);
        border-radius: 25px;
        padding: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        gap: 10px;
        border-bottom: 8px solid #8cc63f;
      }
      .screen-bezel {
        background: #1a1a1a;
        padding: 8px;
        border-radius: 12px;
      }
      textarea.lcd-screen {
        width: 100%;
        height: 60px;
        background: #242e22;
        border: none;
        color: var(--paper-preview, #7dff7d);
        font-family: "VT323", monospace;
        font-size: 22px;
        resize: none;
        outline: none;
        box-sizing: border-box;
        padding: 8px;
      }
      .search-bar {
        width: 100%;
        background: #1a1a1a;
        border-radius: 8px;
        display: flex;
        align-items: center;
        padding: 4px 8px;
        box-sizing: border-box;
        margin-bottom: 5px;
      }
      .search-bar input {
        background: transparent;
        border: none;
        color: #7dff7d;
        font-family: "VT323", monospace;
        width: 100%;
        outline: none;
        font-size: 16px;
      }
      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .tool-btn {
        width: 40px;
        height: 40px;
        background: var(--ui-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        cursor: pointer;
        pointer-events: auto;
      }
      .print-btn {
        background: var(--accent-red);
        color: #fff;
        border: none;
        padding: 0 20px;
        height: 40px;
        border-radius: 12px;
        font-weight: bold;
        cursor: pointer;
        pointer-events: auto;
      }

      /* --- ä¾¿ç­¾æ ¸å¿ƒæ ·å¼ä¿®æ”¹ --- */
      .receipt {
        position: absolute;
        width: var(--note-width);
        background: var(--this-paper-color); /* åªæœ‰ä¸­é—´æ˜¯å®å¿ƒèƒŒæ™¯ */
        padding: 10px 20px; /* è°ƒæ•´å†…è¾¹è·ï¼Œå› ä¸ºä¸Šä¸‹ç°åœ¨æ˜¯ä¼ªå…ƒç´  */
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        z-index: 50;
        transition: transform 0.2s;
        pointer-events: auto;
        box-sizing: border-box;
        /* ç§»é™¤ clip-pathï¼Œè§£å†³å¡é¡¿çš„æ ¸å¿ƒ */
        clip-path: none !important;
        will-change: left, top;
      }

      /* é¡¶éƒ¨é”¯é½¿ */
      .receipt::before {
        content: "";
        position: absolute;
        top: -6px; /* SVGé«˜åº¦ */
        left: 0;
        width: 100%;
        height: 6px;
        background-color: var(--this-paper-color);
        /* ä½¿ç”¨é®ç½©æŠ€æœ¯ï¼Œè®©é”¯é½¿è‡ªåŠ¨è·Ÿéšä¾¿ç­¾é¢œè‰² */
        -webkit-mask-image: var(--sawtooth-url);
        mask-image: var(--sawtooth-url);
        /* ç¿»è½¬ç”¨äºé¡¶éƒ¨ */
        transform: scaleY(-1);
        transform-origin: bottom;
      }

      /* åº•éƒ¨é”¯é½¿ */
      .receipt::after {
        content: "";
        position: absolute;
        bottom: -6px; /* SVGé«˜åº¦ */
        left: 0;
        width: 100%;
        height: 6px;
        background-color: var(--this-paper-color);
        -webkit-mask-image: var(--sawtooth-url);
        mask-image: var(--sawtooth-url);
        /* åº•éƒ¨ä¸éœ€è¦ç¿»è½¬ */
      }

      .receipt.dragging {
        scale: 1.02;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        z-index: 9999 !important;
        cursor: grabbing;
        /* ä»¥å‰è¿™é‡Œéœ€è¦ç§»é™¤ clip-pathï¼Œç°åœ¨ä¸éœ€è¦äº†ï¼Œå› ä¸ºæ ¹æœ¬æ²¡æœ‰ clip-path */
      }

      .receipt.hidden-note {
        display: none;
      }
      .receipt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10px;
        color: rgba(0, 0, 0, 0.3);
        border-bottom: 1px dashed rgba(0, 0, 0, 0.08);
        padding-bottom: 6px;
        pointer-events: none;
      }
      .close-btn {
        cursor: pointer;
        font-size: 18px;
        line-height: 24px;
        pointer-events: auto;
      }
      .receipt-content {
        font-weight: 700;
        color: #111;
        font-size: 14px;
        white-space: pre-wrap;
        margin: 10px 0;
        min-height: 40px;
        outline: none;
      }
      .zoom-controls {
        position: fixed;
        right: 20px;
        bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: auto;
        z-index: 3000;
      }
      .zoom-btn {
        width: 50px;
        height: 50px;
        background: white;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border: 1px solid #eee;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="viewport"></div>
    <div class="fixed-ui">
      <div class="pager-container">
        <div class="pager-body">
          <div class="search-bar">
            <span style="color: #7dff7d; margin-right: 5px">ğŸ”</span>
            <input
              type="text"
              id="searchInp"
              placeholder="SEARCH NOTES..."
              oninput="handleSearch(this.value)"
            />
          </div>
          <div class="screen-bezel">
            <textarea
              id="inputText"
              class="lcd-screen"
              placeholder="TYPE MESSAGE..."
            ></textarea>
          </div>
          <div class="controls">
            <div style="display: flex; gap: 10px">
              <div class="tool-btn" onclick="toggleColor()">ğŸ¨</div>
              <div class="tool-btn" onclick="clearAllInputs()">ğŸ—‘ï¸</div>
            </div>
            <button class="print-btn" onclick="printReceipt()">PRINT</button>
          </div>
        </div>
      </div>
      <div class="zoom-controls">
        <div class="zoom-btn" onclick="changeZoom(0.1)">ï¼‹</div>
        <div class="zoom-btn" onclick="changeZoom(-0.1)">ï¼</div>
        <div class="zoom-btn" onclick="focusAllReceipts(true)">ALL</div>
        <div class="zoom-btn" onclick="resetCanvasToCenter()">â†º</div>
      </div>
    </div>

    <script>
      const SB_URL = "https://wuronegjubkyevlviswt.supabase.co";
      const SB_KEY = "sb_publishable__FBQPQmrAdcZkixiLgA-xw_j50DyJ8q"; // è¯·ç¡®ä¿è¿™æ˜¯æœ‰æ•ˆçš„ Key
      let sb = null,
        viewport,
        scale = 1,
        offsetX = 0,
        offsetY = 0,
        zIndexCounter = 100,
        currentColorIndex = 0;
      const paperColors = [
        { bg: "#ffffff", p: "#7dff7d" },
        { bg: "#fff9c4", p: "#fff9c4" },
        { bg: "#c8e6c9", p: "#c8e6c9" },
        { bg: "#f8bbd0", p: "#f8bbd0" },
        { bg: "#e1f5fe", p: "#e1f5fe" },
        { bg: "#ede7f6", p: "#ede7f6" },
        { bg: "#ffe0b2", p: "#ffe0b2" },
      ];

      let audioCtx;
      function initAudio() {
        if (!audioCtx)
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      function playSfx(f, t = "sine", v = 0.02, d = 0.1) {
        initAudio();
        if (audioCtx && audioCtx.state === "suspended") {
          audioCtx.resume().catch((e) => {});
        }
        if (!audioCtx) return;
        try {
          const o = audioCtx.createOscillator(),
            g = audioCtx.createGain();
          o.type = t;
          o.frequency.setValueAtTime(f, audioCtx.currentTime);
          g.gain.setValueAtTime(v, audioCtx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d);
          o.connect(g);
          g.connect(audioCtx.destination);
          o.start();
          o.stop(audioCtx.currentTime + d);
        } catch (e) {}
      }

      async function initApp() {
        viewport = document.getElementById("viewport");

        try {
          if (window.supabase) {
            sb = window.supabase.createClient(SB_URL, SB_KEY);
          }
        } catch (e) {
          console.error("Supabase init error:", e);
        }

        document.getElementById("inputText").addEventListener("input", () => {
          playSfx(1000 + Math.random() * 200, "sine", 0.015, 0.05);
        });

        if (sb) {
          try {
            const { data } = await sb.from("notes").select("*");
            if (data && data.length > 0) {
              data.forEach((item) => {
                renderReceipt(item.id, item, true);
                if (item.z_index)
                  zIndexCounter = Math.max(
                    zIndexCounter,
                    parseInt(item.z_index)
                  );
              });
              setTimeout(() => focusAllReceipts(true), 300);
            }

            sb.channel("db-changes")
              .on(
                "postgres_changes",
                { event: "*", schema: "public", table: "notes" },
                (payload) => {
                  if (payload.eventType === "INSERT") {
                    if (
                      !document.querySelector(
                        `[data-note-id="${payload.new.note_id}"]`
                      )
                    ) {
                      renderReceipt(payload.new.id, payload.new, true);
                      playSfx(1000, "sine", 0.03, 0.4);
                    } else {
                      const local = document.querySelector(
                        `[data-note-id="${payload.new.note_id}"]`
                      );
                      if (local) local.dataset.dbId = payload.new.id;
                    }
                  } else if (payload.eventType === "UPDATE") {
                    const el = document.querySelector(
                      `[data-db-id="${payload.new.id}"]`
                    );
                    if (
                      el &&
                      el.dataset.saving !== "true" &&
                      !el.classList.contains("dragging")
                    ) {
                      el.style.transition = "all 0.5s ease";
                      el.style.left = payload.new.left_pos;
                      el.style.top = payload.new.top_pos;
                      el.style.zIndex = payload.new.z_index;
                      el.querySelector(".receipt-content").innerText =
                        payload.new.content;
                      setTimeout(() => (el.style.transition = "none"), 500);
                    }
                  } else if (payload.eventType === "DELETE") {
                    document
                      .querySelector(`[data-db-id="${payload.old.id}"]`)
                      ?.remove();
                    playSfx(200, "sawtooth", 0.02, 0.2);
                  }
                }
              )
              .subscribe();
          } catch (e) {
            console.log("Data fetch error", e);
          }
        }

        initCanvasPan();
      }

      async function saveToCloud(el) {
        if (!sb || el.dataset.saving === "true") return;
        const content = el.querySelector(".receipt-content").innerText.trim();
        if (!content) return;
        el.dataset.saving = "true";
        const dbId = el.dataset.dbId;
        const payload = {
          note_id: el.dataset.noteId,
          content: content,
          color: el.style.getPropertyValue("--this-paper-color"),
          left_pos: el.style.left,
          top_pos: el.style.top,
          z_index: parseInt(el.style.zIndex) || 100,
          date_str: el.querySelector(".footer-date").innerText,
        };
        try {
          if (!dbId || dbId === "null" || dbId === "undefined") {
            const { data } = await sb.from("notes").insert([payload]).select();
            if (data) el.dataset.dbId = data[0].id;
          } else {
            await sb.from("notes").update(payload).eq("id", dbId);
          }
        } catch (e) {
          console.log("Save error", e);
        } finally {
          el.dataset.saving = "false";
        }
      }

      function renderReceipt(dbId, data, isInit = false) {
        if (dbId && document.querySelector(`[data-db-id="${dbId}"]`)) return;
        if (
          data.note_id &&
          document.querySelector(`[data-note-id="${data.note_id}"]`)
        )
          return;

        const receipt = document.createElement("div");
        receipt.className = "receipt";
        receipt.dataset.dbId = dbId;
        receipt.dataset.noteId = data.note_id;
        receipt.style.setProperty(
          "--this-paper-color",
          data.color || "#ffffff"
        );
        receipt.style.left = data.left_pos;
        receipt.style.top = data.top_pos;
        receipt.style.zIndex = data.z_index || 100;

        receipt.innerHTML = `
            <div class="receipt-header"><span>${data.note_id}</span><span class="close-btn" onclick="removeReceipt(this)">Ã—</span></div>
            <div class="receipt-content" contenteditable="true" spellcheck="false"></div>
            <div style="display:flex; justify-content:space-between; font-size:8px; color:rgba(0,0,0,0.2); border-top:1px dashed rgba(0,0,0,0.08); padding-top:10px; pointer-events:none;">
                <span>ID:${data.note_id}</span><span class="footer-date">${data.date_str}</span>
            </div>`;

        viewport.appendChild(receipt);
        const contentEl = receipt.querySelector(".receipt-content");

        if (isInit) {
          contentEl.innerText = data.content;
        } else {
          setTimeout(() => {
            receipt.style.transition =
              "top 0.8s cubic-bezier(0.22, 1, 0.36, 1)";
            receipt.style.top = data.target_y;
            setTimeout(() => {
              receipt.style.transition = "none";
              saveToCloud(receipt);
            }, 810);
          }, 50);
          typeWriter(contentEl, data.content);
        }

        receipt.addEventListener("dblclick", (e) => {
          if (e.target !== contentEl) focusSingleReceipt(receipt);
        });
        contentEl.addEventListener("blur", () => saveToCloud(receipt));
        contentEl.addEventListener("input", () =>
          playSfx(1200, "sine", 0.005, 0.02)
        );
        makeDraggable(receipt);
      }

      function makeDraggable(el) {
        let isD = false,
          sx,
          sy,
          ix,
          iy;
        const start = (e) => {
          if (
            e.target.classList.contains("close-btn") ||
            e.target.contentEditable === "true"
          )
            return;
          e.stopPropagation();
          isD = true;
          el.classList.add("dragging");
          el.style.zIndex = ++zIndexCounter;
          const t = e.type.includes("touch") ? e.touches[0] : e;
          sx = t.clientX;
          sy = t.clientY;
          ix = parseFloat(el.style.left);
          iy = parseFloat(el.style.top);
          playSfx(600, "sine", 0.01, 0.05);
        };
        const move = (e) => {
          if (!isD) return;
          const t = e.type.includes("touch") ? e.touches[0] : e;
          // GPUåŠ é€Ÿæ¸²æŸ“ï¼Œæ— DOMæŸ¥è¯¢
          el.style.left = ix + (t.clientX - sx) / scale + "px";
          el.style.top = iy + (t.clientY - sy) / scale + "px";
        };
        const end = () => {
          if (isD) {
            isD = false;
            el.classList.remove("dragging");
            let tx = parseFloat(el.style.left),
              ty = parseFloat(el.style.top);
            const grid = 20,
              snap = 30;
            const others = document.querySelectorAll(
              `.receipt:not([data-note-id="${el.dataset.noteId}"])`
            );
            others.forEach((o) => {
              const ox = parseFloat(o.style.left),
                oy = parseFloat(o.style.top);
              const ow = o.offsetWidth,
                oh = o.offsetHeight;
              if (Math.abs(ty - oy) < snap) {
                if (Math.abs(tx - (ox + ow)) < snap) tx = ox + ow;
                if (Math.abs(tx + 320 - ox) < snap) tx = ox - 320;
                ty = oy;
              }
              if (Math.abs(tx - ox) < snap) {
                if (Math.abs(ty - (oy + oh)) < snap) ty = oy + oh;
                if (Math.abs(ty + el.offsetHeight - oy) < snap)
                  ty = oy - el.offsetHeight;
                tx = ox;
              }
            });
            el.style.left = Math.round(tx / grid) * grid + "px";
            el.style.top = Math.round(ty / grid) * grid + "px";
            saveToCloud(el);
            playSfx(400, "sine", 0.01, 0.05);
          }
        };
        el.addEventListener("mousedown", start);
        el.addEventListener("touchstart", start, { passive: false });
        window.addEventListener("mousemove", move);
        window.addEventListener("touchmove", move, { passive: false });
        window.addEventListener("mouseup", end);
        window.addEventListener("touchend", end);
      }

      function printReceipt() {
        const input = document.getElementById("inputText");
        const text = input.value.trim();
        if (!text) return;
        playSfx(800, "sawtooth", 0.03, 0.4);
        const nid = `PGR-${Math.floor(Math.random() * 9000 + 1000)}`;
        const date = new Date()
          .toLocaleString("zh-CN", {
            year: "numeric",
            month: "numeric",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
          })
          .replace(/\//g, "/");

        const x = (window.innerWidth / 2 - offsetX) / scale - 160;
        const startY = (window.innerHeight - 180 - offsetY) / scale;
        const targetY = (window.innerHeight / 2 - 100 - offsetY) / scale;

        renderReceipt(null, {
          note_id: nid,
          content: text,
          color: paperColors[currentColorIndex].bg,
          left_pos: x + "px",
          top_pos: startY + "px",
          target_y: targetY + "px",
          z_index: ++zIndexCounter,
          date_str: date,
        });
        input.value = "";
      }

      function handleSearch(val) {
        const q = val.toLowerCase().trim();
        document.querySelectorAll(".receipt").forEach((n) => {
          const t = n.querySelector(".receipt-content").innerText.toLowerCase();
          n.classList.toggle("hidden-note", q !== "" && !t.includes(q));
        });
      }

      function clearAllInputs() {
        document.getElementById("inputText").value = "";
        const s = document.getElementById("searchInp");
        s.value = "";
        handleSearch("");
        playSfx(200, "sawtooth", 0.03, 0.1);
      }

      function focusSingleReceipt(el) {
        const x = parseFloat(el.style.left) + 160;
        const y = parseFloat(el.style.top) + el.offsetHeight / 2;
        scale = 1;
        offsetX = window.innerWidth / 2 - x * scale;
        offsetY = window.innerHeight / 2 - y * scale;
        viewport.style.transition = "all 0.5s ease";
        applyTransform();
        setTimeout(() => (viewport.style.transition = "none"), 500);
      }

      function typeWriter(el, text, cb) {
        let i = 0;
        const cur = document.createElement("span");
        cur.className = "cursor";
        el.innerHTML = "";
        el.appendChild(cur);
        function type() {
          if (i < text.length) {
            el.insertBefore(document.createTextNode(text[i]), cur);
            i++;
            playSfx(800 + Math.random() * 200, "sine", 0.01, 0.02);
            setTimeout(type, 30);
          } else {
            cur.remove();
            if (cb) cb();
          }
        }
        type();
      }

      function initCanvasPan() {
        let isP = false,
          sx,
          sy;
        const start = (e) => {
          if (e.target !== viewport && e.target !== document.body) return;
          isP = true;
          const t = e.type.includes("touch") ? e.touches[0] : e;
          sx = t.clientX - offsetX;
          sy = t.clientY - offsetY;
        };
        const move = (e) => {
          if (!isP) return;
          const t = e.type.includes("touch") ? e.touches[0] : e;
          offsetX = t.clientX - sx;
          offsetY = t.clientY - sy;
          applyTransform();
        };
        window.addEventListener("mousedown", start);
        window.addEventListener("mousemove", move);
        window.addEventListener("mouseup", () => (isP = false));
        window.addEventListener("touchstart", start, { passive: false });
        window.addEventListener("touchmove", move, { passive: false });
        window.addEventListener("touchend", () => (isP = false));
      }

      async function removeReceipt(btn) {
        const el = btn.closest(".receipt");
        const dbId = el.dataset.dbId;
        el.remove();
        playSfx(150, "sawtooth", 0.03, 0.1);
        if (dbId && dbId !== "null" && sb)
          await sb.from("notes").delete().eq("id", dbId);
      }

      function applyTransform() {
        viewport.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
      }
      function changeZoom(d) {
        scale = Math.min(Math.max(0.1, scale + d), 3);
        applyTransform();
        playSfx(1500, "sine", 0.005, 0.05);
      }

      function focusAllReceipts(shouldScale = true) {
        const items = document.querySelectorAll(".receipt:not(.hidden-note)");
        if (!items.length) {
          scale = 1;
          offsetX = 0;
          offsetY = 0;
          applyTransform();
          return;
        }

        let minX = Infinity,
          maxX = -Infinity,
          minY = Infinity,
          maxY = -Infinity;
        items.forEach((el) => {
          const x = parseFloat(el.style.left),
            y = parseFloat(el.style.top);
          minX = Math.min(minX, x);
          maxX = Math.max(maxX, x + 320);
          minY = Math.min(minY, y);
          maxY = Math.max(maxY, y + el.offsetHeight);
        });

        const centerX = (minX + maxX) / 2;
        const centerY = (minY + maxY) / 2;

        if (shouldScale) {
          scale = Math.min(
            window.innerWidth / (maxX - minX + 100),
            (window.innerHeight - 300) / (maxY - minY + 100),
            1
          );
        } else {
          scale = 1;
        }

        offsetX = window.innerWidth / 2 - centerX * scale;
        offsetY = window.innerHeight / 2 - centerY * scale;

        viewport.style.transition = "all 0.6s ease";
        applyTransform();
        setTimeout(() => (viewport.style.transition = "none"), 600);
        playSfx(700, "sine", 0.01, 0.3);
      }

      function resetCanvasToCenter() {
        focusAllReceipts(false);
      }

      function toggleColor() {
        currentColorIndex = (currentColorIndex + 1) % paperColors.length;
        document
          .getElementById("inputText")
          .style.setProperty(
            "--paper-preview",
            paperColors[currentColorIndex].p
          );
        playSfx(1000, "sine", 0.02, 0.1);
      }

      window.onload = () => {
        // æš—å·åŠŸèƒ½å·²å¯ç”¨
        const code = prompt("è¯·è¾“å…¥æš—å·ï¼š");
        if (code === "123456") {
          initAudio();
          initApp();
        } else {
          alert("æš—å·é”™è¯¯");
          document.body.innerHTML =
            "<div style='color:#333; text-align:center; padding-top:100px;'>ACCESS DENIED</div>";
        }
      };
    </script>
  </body>
</html>
