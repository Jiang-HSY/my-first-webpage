<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ÊàëÁöÑ‰∫ë‰æøÁ≠æ - ÂÖ®ÂäüËÉΩÁâà</title>
    <link
      href="https://fonts.loli.net/css2?family=VT323&family=Space+Mono:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://npm.elemecdn.com/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --pager-green: #a3d95b;
        --accent-red: #ff6b6b;
        --ui-bg: #2a2a2a;
      }
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        background-color: #f0f2f5;
        background-image: linear-gradient(
            rgba(200, 210, 220, 0.4) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(200, 210, 220, 0.4) 1px, transparent 1px);
        background-size: 35px 35px;
        overflow: hidden;
        font-family: "Space Mono", monospace;
        user-select: none;
        -webkit-touch-callout: none;
      }
      #viewport {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        transform-origin: 0 0;
        cursor: grab;
      }
      #viewport:active {
        cursor: grabbing;
      }
      .fixed-ui {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
      }
      .pager-container {
        pointer-events: auto;
        margin-bottom: 20px;
        position: relative;
        z-index: 3000;
        width: 90%;
        max-width: 420px;
      }
      .pager-body {
        background-color: var(--pager-green);
        border-radius: 25px;
        padding: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        gap: 12px;
        border-bottom: 8px solid #8cc63f;
      }
      .screen-bezel {
        background: #1a1a1a;
        padding: 10px;
        border-radius: 12px;
      }
      textarea.lcd-screen {
        width: 100%;
        height: 75px;
        background: #242e22;
        border: none;
        color: var(--paper-preview, #7dff7d);
        font-family: "VT323", monospace;
        font-size: 24px;
        resize: none;
        outline: none;
        box-sizing: border-box;
        padding: 8px;
        overflow-y: auto;
      }
      .controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .icon-btns {
        display: flex;
        gap: 10px;
      }
      .tool-btn {
        width: 42px;
        height: 42px;
        background: var(--ui-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        pointer-events: auto;
        font-size: 18px;
        cursor: pointer;
        border: 1px solid #444;
      }
      .print-btn {
        background: var(--accent-red);
        color: #fff;
        border: none;
        padding: 0 25px;
        height: 45px;
        border-radius: 12px;
        font-weight: bold;
        cursor: pointer;
        pointer-events: auto;
      }

      .zoom-controls {
        position: fixed;
        right: 20px;
        bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        pointer-events: auto;
        z-index: 4000;
      }
      .zoom-btn {
        width: 45px;
        height: 45px;
        background: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        color: #666;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        border: 1px solid #eee;
      }

      .receipt {
        position: absolute;
        width: 230px;
        background: var(--this-paper-color);
        padding: 12px 18px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.06);
        touch-action: none;
        z-index: 50;
        transition: top 0.8s cubic-bezier(0.2, 0.8, 0.2, 1.05);
        clip-path: polygon(
          0% 4px,
          2.5% 0,
          5% 4px,
          7.5% 0,
          10% 4px,
          12.5% 0,
          15% 4px,
          17.5% 0,
          20% 4px,
          22.5% 0,
          25% 4px,
          27.5% 0,
          30% 4px,
          32.5% 0,
          35% 4px,
          37.5% 0,
          40% 4px,
          42.5% 0,
          45% 4px,
          47.5% 0,
          50% 4px,
          52.5% 0,
          55% 4px,
          57.5% 0,
          60% 4px,
          62.5% 0,
          65% 4px,
          67.5% 0,
          70% 4px,
          72.5% 0,
          75% 4px,
          77.5% 0,
          80% 4px,
          82.5% 0,
          85% 4px,
          87.5% 0,
          90% 4px,
          92.5% 0,
          95% 4px,
          97.5% 0,
          100% 4px,
          100% calc(100% - 4px),
          97.5% 100%,
          95% calc(100% - 4px),
          92.5% 100%,
          90% calc(100% - 4px),
          87.5% 100%,
          85% calc(100% - 4px),
          82.5% 100%,
          80% calc(100% - 4px),
          77.5% 100%,
          75% calc(100% - 4px),
          72.5% 100%,
          70% calc(100% - 4px),
          67.5% 100%,
          65% calc(100% - 4px),
          62.5% 100%,
          60% calc(100% - 4px),
          57.5% 100%,
          55% calc(100% - 4px),
          52.5% 100%,
          50% calc(100% - 4px),
          47.5% 100%,
          45% calc(100% - 4px),
          42.5% 100%,
          40% calc(100% - 4px),
          37.5% 100%,
          35% calc(100% - 4px),
          32.5% 100%,
          30% calc(100% - 4px),
          27.5% 100%,
          25% calc(100% - 4px),
          22.5% 100%,
          20% calc(100% - 4px),
          17.5% 100%,
          15% calc(100% - 4px),
          12.5% 100%,
          10% calc(100% - 4px),
          7.5% 100%,
          5% calc(100% - 4px),
          2.5% 100%,
          0% calc(100% - 4px)
        );
      }
      .receipt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 10px;
        color: rgba(0, 0, 0, 0.3);
        border-bottom: 1px dashed rgba(0, 0, 0, 0.08);
        padding-bottom: 6px;
        margin-bottom: 10px;
      }
      .close-btn {
        font-size: 24px;
        padding: 5px;
        cursor: pointer;
        color: rgba(0, 0, 0, 0.2);
        pointer-events: auto;
      }
      .receipt-content {
        font-weight: 700;
        color: #111;
        line-height: 1.5;
        font-size: 14px;
        min-height: 30px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .receipt-footer {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        border-top: 1px dashed rgba(0, 0, 0, 0.08);
        padding-top: 8px;
        font-size: 8px;
        color: rgba(0, 0, 0, 0.2);
      }
      .cursor {
        display: inline-block;
        width: 6px;
        height: 14px;
        background: var(--accent-red);
        animation: blink 0.8s infinite;
        vertical-align: middle;
      }
      @keyframes blink {
        50% {
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="viewport"></div>
    <div class="fixed-ui">
      <div class="pager-container">
        <div class="pager-body">
          <div class="screen-bezel">
            <textarea
              id="inputText"
              class="lcd-screen"
              placeholder="TYPE MESSAGE..."
            ></textarea>
          </div>
          <div class="controls">
            <div class="icon-btns">
              <div class="tool-btn" onclick="toggleColor()">üé®</div>
              <div class="tool-btn" onclick="clearText()">üóëÔ∏è</div>
            </div>
            <button class="print-btn" onclick="printReceipt()">PRINT</button>
          </div>
        </div>
      </div>
      <div class="zoom-controls">
        <div class="zoom-btn" onclick="changeZoom(0.1)">Ôºã</div>
        <div class="zoom-btn" onclick="changeZoom(-0.1)">Ôºç</div>
        <div class="zoom-btn" onclick="resetCanvas()">‚Ü∫</div>
        <div class="zoom-btn" onclick="focusAllReceipts()">ALL</div>
      </div>
    </div>

    <script>
      // 1. ÈÖçÁΩÆ
      const SB_URL = "https://wuronegjubkyevlviswt.supabase.co";
      const SB_KEY = "sb_publishable__FBQPQmrAdcZkixiLgA-xw_j50DyJ8q";
      const MY_SECRET_CODE = "123456"; // ‰Ω†ÁöÑÊöóÂè∑

      const paperColors = [
        { bg: "#ffffff", preview: "#7dff7d" },
        { bg: "#fff9c4", preview: "#fff9c4" },
        { bg: "#c8e6c9", preview: "#c8e6c9" },
        { bg: "#f8bbd0", preview: "#f8bbd0" },
      ];

      let supabase,
        viewport,
        currentColorIndex = 0,
        scale = 1,
        offsetX = 0,
        offsetY = 0,
        zIndexCounter = 100;
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      // 2. Èü≥ÊïàÂºïÊìé
      function playSfx(freq, type = "sine", vol = 0.02, duration = 0.05) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
        gain.gain.setValueAtTime(vol, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(
          0.001,
          audioCtx.currentTime + duration
        );
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + duration);
      }
      function playKeyClick() {
        playSfx(1200 + Math.random() * 400, "square", 0.08, 0.03);
      }
      function playMagicEject() {
        [1046, 1318, 1567, 2093].forEach((f, i) =>
          setTimeout(() => playSfx(f, "sine", 0.05, 0.4), i * 60)
        );
      }

      // 3. ÂàùÂßãÂåñÂä†ËΩΩ
      window.onload = async () => {
        const code = prompt("ËØ∑ËæìÂÖ•ËÆøÈóÆÊöóÂè∑Ôºö");
        if (code !== MY_SECRET_CODE) {
          alert("ÊöóÂè∑ÈîôËØØÔºÅ");
          document.body.innerHTML = "<h1>Â∑≤ÊãíÁªùÊéàÊùÉ</h1>";
          return;
        }

        viewport = document.getElementById("viewport");
        supabase = window.supabase.createClient(SB_URL, SB_KEY);

        const { data } = await supabase.from("notes").select("*");
        if (data) {
          data.forEach((item) => renderReceipt(item.id, item, true));
          setTimeout(focusAllReceipts, 500);
        }
      };

      // 4. ‰∫ëÁ´ØÂêåÊ≠•
      async function saveToCloud(el) {
        const payload = {
          note_id: el.querySelector(".receipt-header span").innerText,
          content: el.querySelector(".receipt-content").innerText,
          color: el.style.getPropertyValue("--this-paper-color"),
          left_pos: el.style.left,
          top_pos: el.style.top,
          z_index: parseInt(el.style.zIndex) || 100,
          date_str: el.querySelector(".receipt-footer span:last-child")
            .innerText,
        };
        if (el.dataset.dbId) {
          await supabase
            .from("notes")
            .update(payload)
            .eq("id", el.dataset.dbId);
        } else {
          const { data } = await supabase
            .from("notes")
            .insert([payload])
            .select();
          if (data) el.dataset.dbId = data[0].id;
        }
      }

      // 5. Ê∏≤Êüì‰∏éÊâìÂç∞ÈÄªËæë
      function renderReceipt(dbId, data, isInit = false) {
        const receipt = document.createElement("div");
        receipt.className = "receipt";
        receipt.dataset.dbId = dbId;
        receipt.style.setProperty(
          "--this-paper-color",
          data.color || "#ffffff"
        );
        receipt.style.left = data.left_pos;
        receipt.style.top = data.top_pos;
        receipt.style.zIndex = data.z_index || 100;
        if (isInit) receipt.style.transition = "none";

        receipt.innerHTML = `
          <div class="receipt-header"><span>${data.note_id}</span><span class="close-btn" onclick="removeReceipt(this)">√ó</span></div>
          <div class="receipt-content"></div>
          <div class="receipt-footer"><span>ID:${data.note_id}</span><span>${data.date_str}</span></div>
        `;
        viewport.appendChild(receipt);

        const contentEl = receipt.querySelector(".receipt-content");
        if (isInit) {
          contentEl.innerText = data.content;
        } else {
          typeWriter(contentEl, data.content, () => {
            receipt.style.transition = "none";
            saveToCloud(receipt);
          });
        }

        makeDraggable(receipt);
        zIndexCounter = Math.max(zIndexCounter, data.z_index);
      }

      function typeWriter(el, text, cb) {
        let i = 0;
        const cursor = document.createElement("span");
        cursor.className = "cursor";
        el.appendChild(cursor);
        function type() {
          if (i < text.length) {
            el.insertBefore(
              text[i] === "\n"
                ? document.createElement("br")
                : document.createTextNode(text[i]),
              cursor
            );
            i++;
            setTimeout(type, 30);
          } else {
            cursor.remove();
            if (cb) cb();
          }
        }
        type();
      }

      function printReceipt() {
        const input = document.getElementById("inputText");
        const text = input.value.trim();
        if (!text) return;

        playMagicEject();
        const idStr = `PGR-${Math.floor(Math.random() * 9000 + 1000)}`;
        const dateStr = new Date().toLocaleString([], {
          hour: "2-digit",
          minute: "2-digit",
        });

        const x = (window.innerWidth / 2 - offsetX) / scale - 115;
        const yStart = (window.innerHeight - 200 - offsetY) / scale;

        const data = {
          note_id: idStr,
          content: text,
          color: paperColors[currentColorIndex].bg,
          left_pos: x + "px",
          top_pos: yStart + "px", // ÂàùÂßã‰ΩçÁΩÆÂú®‰∏ãÊñπ
          z_index: ++zIndexCounter,
          date_str: dateStr,
        };

        renderReceipt(null, data);
        const all = document.querySelectorAll(".receipt");
        const newEl = all[all.length - 1];

        // ÂêêÁ∫∏Âä®ÁîªÊïàÊûú
        setTimeout(() => {
          newEl.style.top = yStart - 250 + "px";
        }, 50);

        input.value = "";
      }

      // 6. ‰∫§‰∫í‰∏éÂØπÁÑ¶
      function toggleColor() {
        currentColorIndex = (currentColorIndex + 1) % paperColors.length;
        document
          .getElementById("inputText")
          .style.setProperty(
            "--paper-preview",
            paperColors[currentColorIndex].preview
          );
        playSfx(600);
      }

      function clearText() {
        document.getElementById("inputText").value = "";
        playSfx(200);
      }

      function focusAllReceipts() {
        const items = document.querySelectorAll(".receipt");
        if (!items.length) return resetCanvas();
        const rects = Array.from(items).map((el) => ({
          x: parseFloat(el.style.left),
          y: parseFloat(el.style.top),
          w: 230,
          h: el.offsetHeight,
        }));
        const minX = Math.min(...rects.map((r) => r.x)),
          maxX = Math.max(...rects.map((r) => r.x + r.w));
        const minY = Math.min(...rects.map((r) => r.y)),
          maxY = Math.max(...rects.map((r) => r.y + r.h));
        scale = Math.min(
          (window.innerWidth - 100) / (maxX - minX),
          (window.innerHeight - 300) / (maxY - minY),
          1.2
        );
        offsetX =
          (window.innerWidth - (maxX - minX) * scale) / 2 - minX * scale;
        offsetY =
          (window.innerHeight - (maxY - minY) * scale) / 2 - minY * scale - 50;
        viewport.style.transition = "all 0.5s ease";
        applyTransform();
        setTimeout(() => (viewport.style.transition = "none"), 500);
      }

      function changeZoom(d) {
        scale = Math.min(Math.max(0.1, scale + d), 3);
        applyTransform();
      }
      function resetCanvas() {
        scale = 1;
        offsetX = 0;
        offsetY = 0;
        applyTransform();
      }
      function applyTransform() {
        viewport.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
      }

      function removeReceipt(btn) {
        const el = btn.closest(".receipt");
        if (el.dataset.dbId)
          supabase.from("notes").delete().eq("id", el.dataset.dbId);
        el.remove();
        playSfx(300, "sine", 0.05, 0.1);
      }

      // ÈîÆÁõòÁÇπÂáªÂ£∞
      document.getElementById("inputText").addEventListener("input", (e) => {
        if (e.inputType !== "deleteContentBackward") playKeyClick();
      });

      // 7. ÊãñÊãΩ‰∏éÂπ≥Áßª
      function makeDraggable(el) {
        let isDragging = false,
          startX,
          startY,
          initX,
          initY;
        const start = (e) => {
          if (e.target.classList.contains("close-btn")) return;
          e.stopPropagation();
          isDragging = true;
          el.style.zIndex = ++zIndexCounter;
          el.style.transition = "none";
          const touch = e.type === "touchstart" ? e.touches[0] : e;
          startX = touch.clientX;
          startY = touch.clientY;
          initX = parseFloat(el.style.left);
          initY = parseFloat(el.style.top);
        };
        const move = (e) => {
          if (!isDragging) return;
          const touch = e.type === "touchmove" ? e.touches[0] : e;
          el.style.left = initX + (touch.clientX - startX) / scale + "px";
          el.style.top = initY + (touch.clientY - startY) / scale + "px";
        };
        const end = () => {
          if (isDragging) {
            isDragging = false;
            saveToCloud(el);
          }
        };
        el.addEventListener("mousedown", start);
        el.addEventListener("touchstart", start);
        window.addEventListener("mousemove", move);
        window.addEventListener("touchmove", move);
        window.addEventListener("mouseup", end);
        window.addEventListener("touchend", end);
      }

      // ÁîªÂ∏ÉÂπ≥Áßª
      let isPanning = false,
        panX,
        panY;
      window.addEventListener("mousedown", (e) => {
        if (e.target === viewport || e.target === document.body) {
          isPanning = true;
          panX = e.clientX - offsetX;
          panY = e.clientY - offsetY;
        }
      });
      window.addEventListener("mousemove", (e) => {
        if (isPanning) {
          offsetX = e.clientX - panX;
          offsetY = e.clientY - panY;
          applyTransform();
        }
      });
      window.addEventListener("mouseup", () => (isPanning = false));
    </script>
  </body>
</html>
